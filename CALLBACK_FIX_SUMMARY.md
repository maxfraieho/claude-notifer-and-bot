# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ –∑ –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ö–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é `/context` –≤—ñ–¥–æ–±—Ä–∞–∂–∞–ª–∏—Å—è, –∞–ª–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –Ω–∏—Ö –Ω–µ –º–∞–ª–æ –µ—Ñ–µ–∫—Ç—É.

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ß–µ—Ä–µ–∑ –∞–Ω–∞–ª—ñ–∑ –∫–æ–¥—É –±—É–ª–æ –≤–∏—è–≤–ª–µ–Ω–æ, —â–æ:

1. ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/context` –ø—Ä–∞—Ü—é—î —ñ –ø–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç—É—Å
2. ‚úÖ –ö–Ω–æ–ø–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –≤ `context_commands.py`
3. ‚úÖ –û–±—Ä–æ–±–Ω–∏–∫–∏ callback'—ñ–≤ —ñ—Å–Ω—É—é—Ç—å —ñ –ø—Ä–∞—Ü—é—é—Ç—å
4. ‚úÖ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î `context_commands`
5. ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: Middleware –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –¥–æ `MessageHandler`, –∞–ª–µ –ù–ï –¥–æ `CallbackQueryHandler`!

## üí° –ö–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏

–£ `src/bot/core.py` middleware (auth, security, rate limiting) –¥–æ–¥–∞–≤–∞–ª–æ—Å—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:

```python
# –ë–£–õ–û (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å):
self.app.add_handler(
    MessageHandler(filters.ALL, self._create_middleware_handler(auth_middleware)),
    group=-2,
)
```

–ö–æ–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏–≤ callback –∑–∞–ø–∏—Ç –≤—ñ–¥ –∫–Ω–æ–ø–∫–∏, –≤—ñ–Ω **–ù–ï –ø—Ä–æ—Ö–æ–¥–∏–≤ —á–µ—Ä–µ–∑ middleware**, —Ç–æ–º—É:
- `context.bot_data` –Ω–µ –∑–∞–ø–æ–≤–Ω—é–≤–∞–ª–æ—Å—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏
- `context.bot_data.get("context_commands")` –ø–æ–≤–µ—Ä—Ç–∞–≤ `None`
- Callback handler –Ω–µ –º—ñ–≥ –∑–Ω–∞–π—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

–î–æ–¥–∞–Ω–æ middleware **–î–õ–Ø –í–°–Ü–• –¢–ò–ü–Ü–í** –∑–∞–ø–∏—Ç—ñ–≤ (messages + callbacks):

```python
# –°–¢–ê–õ–û (–¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¢–ê callback'—ñ–≤):
self.app.add_handler(
    MessageHandler(filters.ALL, self._create_middleware_handler(auth_middleware)),
    group=-2,
)
self.app.add_handler(
    CallbackQueryHandler(self._create_middleware_handler(auth_middleware)),
    group=-2,
)
```

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –≤—Å—ñ—Ö middleware:
- üîê Authentication middleware (group -2)
- üõ°Ô∏è Security middleware (group -3)
- ‚è∞ Rate limiting middleware (group -1)
- ü§ñ Claude availability middleware (group -4)

## üìÇ –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

- **`src/bot/core.py`** - –¥–æ–¥–∞–Ω–æ CallbackQueryHandler –¥–ª—è –≤—Å—ñ—Ö middleware

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞
2. –ù–∞–¥—ñ—à–ª—ñ—Ç—å `/context`
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –±—É–¥—å-—è–∫—É –∫–Ω–æ–ø–∫—É - —Ç–µ–ø–µ—Ä –≤–æ–Ω–∏ –º–∞—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏!

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–µ–ø–µ—Ä –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ:**
- üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- üì§ –ï–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- üì• –Ü–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- üîç –ü–æ—à—É–∫ —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ
- üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤
- üóëÔ∏è –û—á–∏—â–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- ‚ùå –ó–∞–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞ –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω:

```bash
docker compose down
docker compose up -d --build
```

–ê–±–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É:
```bash
python -m src.main
```