# Transfer Brief: –õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è - –ö—Ä–∏—Ç–∏—á–Ω—ñ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è

**–î–∞—Ç–∞:** 2025-09-26
**–ê–≤—Ç–æ—Ä:** Claude Code
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ç–∞ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ

## üéØ –†–µ–∑—é–º–µ –∑–º—ñ–Ω

–í–∏–∫–æ–Ω–∞–Ω–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π —ñ–º–ø–æ—Ä—Ç –ø–æ–∫—Ä–∞—â–µ–Ω—å –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó –∑ `/home/vokov/For_fix/localisation_fix`. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å, thread-safety —Ç–∞ –∑—Ä–æ–∑—É–º—ñ–ª—ñ fallback –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

## üìã –ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### 1. **src/localization/i18n.py** - –û—Å–Ω–æ–≤–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

**–ü—Ä–æ–±–ª–µ–º–∞:** `i18n.get()` —ñ–Ω–æ–¥—ñ –ø–æ–≤–µ—Ä—Ç–∞–≤ —Å–∏—Ä–∏–π –∫–ª—é—á —è–∫ —É—Å–ø—ñ—à–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥
**–í–∏—Ä—ñ—à–µ–Ω–æ:**
- ‚úÖ –î–æ–¥–∞–Ω–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É `**kwargs` –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
- ‚úÖ –ó–º—ñ–Ω–µ–Ω–æ fallback –ª–æ–≥—ñ–∫—É: –∑–∞–º—ñ—Å—Ç—å —Å–∏—Ä–æ–≥–æ –∫–ª—é—á–∞ –ø–æ–≤–µ—Ä—Ç–∞—î `[missing translation: key | locale=xx]`
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è

```python
# BEFORE
def get(self, key: str, locale: Optional[str] = None) -> str:
    # –ü–æ–≤–µ—Ä—Ç–∞–≤ —Å–∏—Ä–∏–π –∫–ª—é—á –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø–µ—Ä–µ–∫–ª–∞–¥—É
    return key

# AFTER
def get(self, key: str, locale: Optional[str] = None, **kwargs) -> str:
    # –ü–æ–≤–µ—Ä—Ç–∞—î –∑—Ä–æ–∑—É–º—ñ–ª–µ fallback –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    return f"[missing translation: {key} | locale={target_locale}]"
```

### 2. **src/localization/wrapper.py** - Thread-Safe –∫–µ—à—É–≤–∞–Ω–Ω—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ—Å—Ç–∏–π dict –∫–µ—à –±–µ–∑ thread-safety
**–í–∏—Ä—ñ—à–µ–Ω–æ:**
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ `TTLCache` –∫–ª–∞—Å –∑ `asyncio.Lock()`
- ‚úÖ –î–æ–¥–∞–Ω–æ LRU –ø–æ–≤–µ–¥—ñ–Ω–∫—É —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä–æ–º (–º–∞–∫—Å. 1000 –∑–∞–ø–∏—Å—ñ–≤)
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–ª—è thread-safety
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–æ fallback chain: DB ‚Üí Telegram ‚Üí Default

```python
# BEFORE
_locale_cache: dict = {}  # –ù–µ–±–µ–∑–ø–µ—á–Ω–æ –¥–ª—è concurrent access

# AFTER
class TTLCache:
    def __init__(self, ttl_seconds: int = 600):
        self._cache = OrderedDict()
        self._lock = asyncio.Lock()  # Thread-safe
```

### 3. **src/bot/integration/enhanced_modules.py** - Deprecated –º–µ—Ç–æ–¥–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è deprecated `set_locale()` –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ
**–í–∏—Ä—ñ—à–µ–Ω–æ:**
- ‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –≤–∏–∫–ª–∏–∫ `self.i18n.set_locale("uk")` –∑ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `switch_language()` –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ user_language_storage
- ‚úÖ –î–æ–¥–∞–Ω–æ fallback –¥–æ storage –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –º–æ–≤–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Ç–µ—Å—Ç–∏
```bash
PYTHONPATH=. python test_localization_fixes.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç–∏:**
- ‚úÖ TTLCache: –∫–µ—à—É–≤–∞–Ω–Ω—è, –µ–∫—Å–ø—ñ—Ä–∞—Ü—ñ—è TTL, LRU –ø–æ–≤–µ–¥—ñ–Ω–∫–∞
- ‚úÖ Fallback Messages: `[missing translation: key | locale=xx]` –∑–∞–º—ñ—Å—Ç—å —Å–∏—Ä–∏—Ö –∫–ª—é—á—ñ–≤
- ‚úÖ Locale Detection: –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å UK ‚Üí EN ‚Üí default
- ‚úÖ –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ `**kwargs` –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫

### –°–∏—Å—Ç–µ–º–Ω—ñ —Ç–µ—Å—Ç–∏
```bash
# –ë–∞–∑–æ–≤–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è i18n
PYTHONPATH=. python -c "from src.localization.i18n import i18n; print(i18n.get('commands.start', locale='uk'))"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: üöÄ –†–æ–∑–ø–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –∑ Claude

# –¢–µ—Å—Ç –≤—ñ–¥—Å—É—Ç–Ω—å–æ–≥–æ –∫–ª—é—á–∞
PYTHONPATH=. python -c "from src.localization.i18n import i18n; print(i18n.get('missing.key', locale='uk'))"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: [missing translation: missing.key | locale=uk]
```

## üöÄ –°—Ç–∞—Ç—É—Å –±–æ—Ç—É –ø—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

**–ü—Ä–æ—Ü–µ—Å:** PID 3797 ‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π
**–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è:** uk.json, en.json ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
**–ö–µ—à—É–≤–∞–Ω–Ω—è:** Thread-safe TTL cache ‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π
**Polling:** Telegram API ‚úÖ –ü—Ä–∞—Ü—é—î

### –õ–æ–≥–∏ –∑–∞–ø—É—Å–∫—É:
```
[info] Loaded translations file=/home/vokov/projects/claude-notifer-and-bot/src/localization/translations/uk.json language=uk
[info] Loaded translations file=/home/vokov/projects/claude-notifer-and-bot/src/localization/translations/en.json language=en
[info] Dependencies injected into application bot_data deps=['localization', 'user_language_storage', ...]
```

## üõ°Ô∏è –ü–µ—Ä–µ–≤–∞–≥–∏ –ø–æ–∫—Ä–∞—â–µ–Ω—å

### –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å
- **Fallback –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:** –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—ñ–ª—å—à–µ –Ω–µ –±–∞—á–∏—Ç—å —Å–∏—Ä—ñ –∫–ª—é—á—ñ —Ç–∏–ø—É `commands.unknown`
- **Thread-safety:** –ö–µ—à –ª–æ–∫–∞–ª—ñ —Ç–µ–ø–µ—Ä –±–µ–∑–ø–µ—á–Ω–∏–π –¥–ª—è concurrent –¥–æ—Å—Ç—É–ø—É
- **–ê—Ç–æ–º–∞—Ä–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó:** –í—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∫–µ—à—É–≤–∞–Ω–Ω—è –∑–∞—Ö–∏—â–µ–Ω—ñ asyncio.Lock

### –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
- **LRU –∫–µ—à:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–π—Å—Ç–∞—Ä—à–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—ñ
- **TTL —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∫–æ–∂–Ω—ñ 10 —Ö–≤–∏–ª–∏–Ω
- **–†–æ–∑—É–º–Ω–∏–π fallback:** –ö–µ—à—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª

### –†–æ–∑—Ä–æ–±–∫–∞
- **–õ–æ–≥—É–≤–∞–Ω–Ω—è:** –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –≤—Å—ñ—Ö fallback –≤–∏–ø–∞–¥–∫—ñ–≤
- **–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è:** –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∑–º—ñ–Ω–Ω–∏—Ö —É –ø–µ—Ä–µ–∫–ª–∞–¥–∞—Ö —á–µ—Ä–µ–∑ `**kwargs`
- **Backward compatibility:** –Ü—Å–Ω—É—é—á–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–≤–∂—É—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ/–ø—ñ—Å–ª—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü—ñ—Å–ª—è | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|---------|-----|-------|------------|
| Missing key handling | –°–∏—Ä–∏–π –∫–ª—é—á | –ó—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è | ‚úÖ UX |
| Thread safety | ‚ùå None | ‚úÖ asyncio.Lock | ‚úÖ Stability |
| Cache management | ‚ùå Manual | ‚úÖ Automatic LRU+TTL | ‚úÖ Memory |
| Error logging | ‚ùå Minimal | ‚úÖ Detailed | ‚úÖ Debug |
| Formatting support | ‚ùå External | ‚úÖ Built-in kwargs | ‚úÖ DX |

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ:
- `src/localization/i18n.py` - Fallback –ª–æ–≥—ñ–∫–∞ + kwargs
- `src/localization/wrapper.py` - Thread-safe TTL –∫–µ—à
- `src/bot/integration/enhanced_modules.py` - –í–∏–¥–∞–ª–µ–Ω–æ deprecated –º–µ—Ç–æ–¥–∏

### –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
- –î–æ–¥–∞–Ω–æ `from collections import OrderedDict`
- –î–æ–¥–∞–Ω–æ `import time` –¥–ª—è TTL timestamps
- –ë–µ–∑ –Ω–æ–≤–∏—Ö –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

### –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è:
- TTL: 600 —Å–µ–∫—É–Ω–¥ (10 —Ö–≤–∏–ª–∏–Ω)
- Max cache size: 1000 –∑–∞–ø–∏—Å—ñ–≤
- LRU cleanup: 10% –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—ñ
- Default locale: "uk" (–∑ .env)

## üéâ –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ Production

### –ß–µ–∫–ª—ñ—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ:
- [x] i18n.get() –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î —Å–∏—Ä–∏–π –∫–ª—é—á
- [x] Thread-safe –∫–µ—à—É–≤–∞–Ω–Ω—è –∑ proper locking
- [x] –í–∏–¥–∞–ª–µ–Ω–æ –≤—Å—ñ deprecated set_locale() –≤–∏–∫–ª–∏–∫–∏
- [x] –î–æ–¥–∞–Ω–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—ñ–≤
- [x] –¢–µ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ
- [x] –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ —Ç–∞ –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ
- [x] –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É

### –†–∏–∑–∏–∫–∏ –º—ñ—Ç–∏–≥—ñ—Ä–æ–≤–∞–Ω–æ:
- **UI –∑–º—ñ–Ω–∏:** Fallback —Ñ–æ—Ä–º–∞—Ç –ª–µ–≥–∫–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î—Ç—å—Å—è –∫–æ–¥–æ–º
- **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:** TTL –∫–µ—à –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
- **Compatibility:** –Ü—Å–Ω—É—é—á–∏–π –∫–æ–¥ –ø—Ä–∞—Ü—é—î –±–µ–∑ –∑–º—ñ–Ω

## üìà –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:** –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –ª–æ–≥–∏ fallback –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤ production
2. **–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:** –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –º–æ–≤ —á–µ—Ä–µ–∑ –ø–æ–∫—Ä–∞—â–µ–Ω–µ API
3. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è:** –¢—é–Ω—ñ–Ω–≥ TTL —Ç–∞ cache size –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ –º–µ—Ç—Ä–∏–∫–∞—Ö
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** –û–Ω–æ–≤–ª–µ–Ω–Ω—è API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤

---

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ç–µ–ø–µ—Ä production-ready –∑ –Ω–∞–¥—ñ–π–Ω–∏–º fallback handling, thread-safe –∫–µ—à—É–≤–∞–Ω–Ω—è–º —Ç–∞ –∑—Ä—É—á–Ω–∏–º API –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±—ñ–ª—å—à–µ –Ω–µ –±–∞—á–∞—Ç—å —Å–∏—Ä—ñ –∫–ª—é—á—ñ, –∞ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ –º–∞—é—Ç—å –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É.